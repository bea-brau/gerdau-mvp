<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERDAU – Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- ======== SIDEBAR ======== -->
    <aside class="sidebar">
        <div class="logo">GERDAU</div>

        <a href="#" class="active">Dashboard</a>
        <a href="#">Relatórios</a>
        <a href="#">Construtor de Relatórios</a>
        <a href="#">IA – Busca Inteligente</a>
        <a href="#">Anomalias</a>
        <a href="#">Previsões</a>
        <a href="#">Configurações</a>
    </aside>

    <!-- ======== ÁREA PRINCIPAL ======== -->
    <main class="main">

        <!-- ======== TÍTULO ======== -->
        <h1>Dashboard</h1>

        <!-- ======== CARD DE UPLOAD ======== -->
        <div class="card">
            <h2>Enviar arquivo de produção</h2>
            <label class="upload-box" for="fileInput">
                Clique aqui para enviar um arquivo Excel (.xlsx)
            </label>
            <input type="file" id="fileInput" accept=".xlsx">

            <button onclick="enviarArquivo()">Enviar</button>

            <p id="status" style="margin-top: 15px; color: #005fa3;"></p>
        </div>

        <!-- ======== KPIS ======== -->
        <div class="kpi-box">
            <div class="kpi-item">
                <strong>Custo Total</strong><br>
                <span id="kpi-custo">R$ —</span>
            </div>

            <div class="kpi-item">
                <strong>Custo Unitário</strong><br>
                <span id="kpi-unitario">R$ —</span>
            </div>

            <div class="kpi-item">
                <strong>Variação</strong><br>
                <span id="kpi-variacao">— %</span>
            </div>

            <div class="kpi-item">
                <strong>Anomalias Encontradas</strong><br>
                <span id="kpi-anomalias">0</span>
            </div>
        </div>

        <!-- ======== TABELA DE RESULTADOS ======== -->
        <div class="card">
            <h2>Resultados</h2>
            <table>
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Custo Total (R$)</th>
                        <th>Custo Unitário (R$)</th>
                        <th>Variação (%)</th>
                    </tr>
                </thead>
                <tbody id="tabela-resultados">
                    <tr><td colspan="4">Nenhum dado carregado</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            © 2025 – MVP Gerdau (Protótipo acadêmico)
        </div>

    </main>

    <!-- ======== SCRIPT PARA ENVIO AO BACKEND ======== -->
    <script>
        const API_URL = "https://gerdau-mvp-backend.onrender.com/process";

        async function enviarArquivo() {
            const fileInput = document.getElementById("fileInput");
            const status = document.getElementById("status");

            if (!fileInput.files.length) {
                status.textContent = "Selecione um arquivo antes de enviar.";
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            status.innerHTML = "Enviando arquivo...";

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("Erro ao processar arquivo.");
                }

                const data = await response.json();
                status.innerHTML = "Arquivo processado com sucesso!";

                atualizarDashboard(data);

            } catch (error) {
                status.innerHTML = "Erro ao enviar arquivo.";
            }
        }

        /* ====== Preenche os dados retornados pela API ====== */
        function atualizarDashboard(data) {
            document.getElementById("kpi-custo").textContent = `R$ ${data.total_cost}`;
            document.getElementById("kpi-unitario").textContent = `R$ ${data.unit_cost}`;
            document.getElementById("kpi-variacao").textContent = `${data.variation}%`;
            document.getElementById("kpi-anomalias").textContent = data.anomalies;

            const tabela = document.getElementById("tabela-resultados");
            tabela.innerHTML = "";

            data.months.forEach(item => {
                const linha = `
                    <tr>
                        <td>${item.mes}</td>
                        <td>R$ ${item.custo_total}</td>
                        <td>R$ ${item.custo_unitario}</td>
                        <td>${item.variacao}%</td>
                    </tr>
                `;
                tabela.innerHTML += linha;
            });
        }
    </script>

</body>
</html>